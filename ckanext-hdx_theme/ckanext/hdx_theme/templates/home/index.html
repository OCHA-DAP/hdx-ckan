{% extends "page.html" %}

{% block subtitle %}{{ _("Welcome") }}{% endblock %}

{% block maintag %}{% endblock %}

{% block content %}
  <div role="main" class="hero">
    <div id="content" class="container">
      {{ self.flash() }}
      {{ self.group_drop() }}
      {{ self.group_map() }}
    </div>
  </div>
  <div class="main homepage">
    <div class="container">
      {{ self.primary_content() }}
    </div>
  </div>
{% endblock %}

{% block group_drop %}
<div id="group_nav">
      <div id="group_nav_text">Choose a country from the dropdown or click on the map</div>
      <div id="group_dropdown" class="pull-right">
        <select id="group_select">
          <option selected value="#">Select country</option>
          {% for group in c.group_package_stuff %}
          {% snippet 'group/snippets/group_dropdown.html', group=group, truncate_title=35 %}
          {% endfor %}
          </select>
      </div>
    </div>
{% endblock %}

{% block group_map %}
<div id="map_outer" style="width:98%; height: 420px">
<div id="map" style="width:100%; height: 400px"></div></div>
  <link rel="stylesheet" href="http://leafletjs.com/dist/leaflet.css">
  
  <script src="/map/leaflet/leaflet.js"></script>
  <script src="/base/vendor/jquery.js"></script>
  <script>
  var world = [
  {% for group in c.group_map %}
  {# Alittle hacky for now, should go through db_to_form_schema #}
      {% for e in group.extras %}
        {% if e.key == 'geojson' %}
          {{e.value|safe}}
          {% if not loop.last %}
          ,
          {% endif %}
        {% endif %}
      {% endfor %}
  {% endfor %}];
  console.log(world)

  var map = L.map('map', {
    center: [48.1642292,16.4541193],
    maxZoom: 3,
    minZoom: 3,
    zoom: 3,
    zoomControl: false
  });
  var groupStyle = {
      "color": "#1b8bbb",
      "weight": 2,
      "opacity": 0.9
  };
  
  L.tileLayer('http://129.206.74.245:8008/tms_rg.ashx?x={x}&y={y}&z={z}', {
    attribution: 'Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'
  }).addTo(map);
  geo = L.geoJson(world, {style:groupStyle,onEachFeature: onEachFeature}).addTo(map);

  function zoomToFeature(e) {
              window.location = e.target.feature.properties.url;
          }
  function pausePan(){
    clearInterval(panning1);
    clearInterval(panning2);
  }

  var panning1, panning2
  window.reverse = false;

  function pan(){
    pos = map.getCenter();
    if(pos.lat < -75){
      window.reverse = true;
    }
    if(pos.lat > 75){
      window.reverse = false;
    }
    if(window.reverse){
      map.panBy([12, -5], {'animate': true, 'duration': .499, 'easeLinearity': 1});
    }else{
      map.panBy([12, 5], {'animate': true, 'duration': .499, 'easeLinearity': 1});
    }
  }

  function pan1(){
    pan();
    clearInterval(window.panning2);
    window.panning1 = setInterval(pan2,500);
  }
  
  function pan2(){
    pan();
    clearInterval(window.panning1);
    window.panning2 = setInterval(pan1,500);
  }
  

  function resumePan(){
    window.panning1 = setInterval(pan2,20)
  }
    
  function onEachFeature(feature, layer) {

      if (feature.properties && feature.properties.name) {
          layer.on({
              mouseover: pausePan,
                mouseout: resumePan,
                click: zoomToFeature
            });
          }
  }
  $('document').ready(function(){
      resumePan();
  });
  </script>

{% endblock %}

{% block primary_content %}
{% block home_secondary_content %}
  <div class="module module-shallow module-narrow module-dark info box">
            {% block home_search %}
              <form class="module-content search-form" method="get" action="{% url_for controller='package', action='search' %}">
                <h3 class="heading">{{ _("Search Your Data") }}</h3>
                <div class="search-input control-group search-giant">
                  <input type="text" class="search" name="q" value="{{ c.q }}" autocomplete="off" placeholder="{{ _('eg. Gold Prices') }}" />
                  <button type="submit">
                    <i class="icon-search"></i>
                    <span>{{ _('Search') }}</span>
                  </button>
                </div>
              </form>
            {% endblock %}
            {# block home_tags %}
              <div class="tags">
                <h3>{{ _('Popular Tags') }}</h3>
                {% set tags = h.get_facet_items_dict('tags', limit=3) %}
                {% for tag in tags %}
                  <a class="tag" href="{% url_for controller='package', action='search', tags=tag.name %}">{{ h.truncate(tag.display_name, 22) }}</a>
                {% endfor %}
              </div>
            {% endblock #}
          </div>
      {% endblock %}

  <div class="module module-popup">
    <div class="module-content box">
      {% block home_primary %}
        <header>
          {% if g.site_intro_text %}
          {{ h.render_markdown(g.site_intro_text) }}
          {% else %}
            {% block home_primary_content %}
              <h1 class="page-heading">{% block home_primary_heading %}{{ _("Welcome to CKAN") }}{% endblock %}</h1>
              <p>
              {% block home_primary_text %}
                {% trans %}This is a nice introductory paragraph about CKAN or the site
                in general. We don't have any copy to go here yet but soon we will
                {% endtrans %}
              {% endblock %}
              </p>
            {% endblock %}
          {% endif %}
        </header>
      {% endblock %}

    </div>
  </div>

{% endblock %}

{% block secondary_content %}
 
{% endblock %}

{% block scripts %}
   {{ super() }}
{% endblock %}

{# Remove the toolbar. #}

{% block toolbar %}{% endblock %}
