{% import 'macros/form.html' as form %}

{% set data = data or {} %}
{% set errors = errors or {} %}
{% set action = form_action or h.url_for(controller='package', action='new_resource', id=pkg_name) %}

{% resource 'hdx_theme/resource_form.js' %}
{% resource 'hdx_theme/css/hdx-icons.css' %}
{# resource 'hdx_theme/hdx-resource-upload-field.js' #}
{% resource 'hdx_theme/datasets/dataset_create.css' %}

{{ h.snippet('widget/loading/loading.html', id="loadingScreen", message="Uploading ... this can take up to a few minutes") }}

{% block secondary %}
{% endblock %}

    <form class="dataset-form dataset-resource-form" method="post" action="{{ action }}" data-module="basic-form resource-form" enctype="multipart/form-data">
        <div class="paddingRowHack">
            <div class="paddingLeftHack paddingRightHack graybg">
                <div class="datasetModule">
                    <div class="pull-right">
                        {% snippet "snippets/help_box.html", links=[{'url':'http://docs.humdata.org/screencasts#submitting-data','text':'Submitting Data'},{'url':'http://docs.humdata.org/screencasts#updating-a-resource','text':'Update Resource'},{'url':'http://docs.humdata.org/get-involved/','text':'Contact Us'}] %}
                    </div>
                    <div class="package-upload-header mTop45 sspBold20 required mBottom40" style="color: #333333">2. {{ _("Select how you'd like to share the data")}}</div>
                    {% block stages %}
                    {# An empty stages variable will not show the stages #}
                    {% if stage %}
                    {{ h.snippet('package/snippets/stages.html', stages=stage, pkg_name=pkg_name) }}
                    {% endif %}
                    {% endblock %}

                    {{ form.errors(error_summary) }}

                    <input name="id" value="{{ data.id }}" type="hidden"/>

                    <div class="control-group dataset-form-resource-types mBottom40">
                        {% block basic_fields %}
                        <div class="controls">
                            {% set is_upload = (data.url_type == 'upload') or  (data.resource_type == "file.upload") %}
                            {#
                            This block uses a slightly odd pattern. Unlike the rest of the radio
                            buttons which are wrapped _inside_ the labels here we place the label
                            after the input. This enables us to style the label based on the state
                            of the radio using css. eg. input[type=radio]+label {}
                            #}
                            <span class="resource-file-uploader pull-left">
                                <input type="file" is-upload="{{is_upload}}" id="mx-file" name="upload" onclick="file_upload_selected();" style="opacity:0; height:0; padding: 0; margin: 0; max-width: 75px;"/>
                                <input id="field-resource-type-upload" type="radio" name="resource_type" value="file.upload" style="opacity:0; height:0; width: 0; position: absolute;"/>
                                <label class="radio inline type-file" for="mx-file" id="mx-type-file" style="display: inline-block;">Upload a file</label>
                                <i class="icon-check"></i>
                            </span>
                            <span class="radio inline pull-left" style="margin-left: 26px; margin-right: 26px; padding: 0;">
                                <span class="control-label"> OR </span>
                            </span>
                            {% set link_upload_string = '' %}
                            {% if not is_upload and data.name %}
                            {% set link_upload_string = 'checked="checked"' %}
                            {% endif %}
                            <span id="field-link-upload" class="resource-file-uploader">
                                <input id="field-resource-type-api" {{ link_upload_string }} type="radio" name="resource_type" value="api" style="visibility: hidden; position: absolute;" />
                                <label style="display: inline-block;" id="mx-type-url" class="radio inline type-url" for="field-resource-type-api">{{ _('Link to URL') }} <div class="underExample">({{ _('eg. API') }})</div></label>
                                <i class="icon-check"></i>
                            </span>
                        </div>
                        {% endblock %}

                        {% block basic_fields_url %}
                        {{ form.input('url', id='field-url', label=_('File or URL'), placeholder=_('eg. http://example.com/population-jan-2011.json'), value=data.url, error=errors.url, classes=['control-full', 'control-large', 'dataset-form-field-wrapper', 'dataset-required']) }}
                        {% endblock %}

                        {% block basic_fields_name %}
                        {{ form.input('name', id='field-name', label=_('Name'), placeholder=_('eg. Population'), value=data.name, error=errors.name, classes=['control-full', 'dataset-form-field-wrapper', 'dataset-required']) }}
                        {% endblock %}

                        {% block basic_fields_description %}
                        {{ form.markdown('description', id='field-description', label=_('Note'), placeholder=_('Some useful notes about the data'), value=data.description, error=errors.description, classes=['dataset-form-field-wrapper']) }}
                        {% endblock %}

                        {% block basic_fields_format %}
                        {% set format_attrs = {'data-module': 'autocomplete', 'data-module-source': '/api/2/util/resource/format_autocomplete?incomplete=?'} %}
                        {% call form.input('format', id='field-format', label=_('Format'), placeholder=_('eg. CSV, XML or JSON'), value=data.format, error=errors.format, classes=['control-medium', 'dataset-form-field-wrapper'], attrs=format_attrs) %}
                        <div class="controls">
                            <div class="explanatoryText">{{ _('HDX will allow previews of certain data formats, like CSV, TXT, XLS, and JSON.  Map previews are also possible if you set the file format to "zipped shapefile", "geojson", or "kml". Map previews may take a few minutes to appear.') }}</div>
                        </div>
                        {% endcall %}
                        {% endblock %}

                        {% block basic_fields_uploader %}
                        {% set username = request.environ.get('REMOTE_USER') %}
                        {% if data.resource_uploader %}
                        {% set resource_uploader = data.resource_uploader %}
                        {% else %}
                        {% set resource_uploader = username %}
                        {% endif %}
                        <div class="control-group">
                            <label class="hide control-label" for="field-uploader">{{ _('Uploader') }}</label>
                            <div class="controls">
                                <input type="hidden" value="{{ username }}" name="resource_uploader" id="field-uploader" readonly="readonly" />
                            </div>
                        </div>
                        {% endblock %}


                        {% block metadata_fields %}
                        {% if include_metadata %}
                        {# TODO: Where do these come from, they don't exist in /package/new_package_form.html #}
                        {# {{ form.select('resource_type', id='field-type', label=_('Resource Type'), options=[{'value': 'empty', 'text': _('Select a type')}], selected="empty", error=errors.type) }} #}

                        {{ form.input('last_modified', id='field-last-modified', label=_('Last Modified'), placeholder=_('eg. 2012-06-05'), value=data.last_modified, error=errors.last_modified, classes=[]) }}

                        {{ form.input('size', id='field-size', label=_('File Size'), placeholder=_('eg. 1024'), value=data.size, error=errors.size, classes=[]) }}

                        {{ form.input('mimetype', id='field-mimetype', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype, error=errors.mimetype, classes=[]) }}

                        {{ form.input('mimetype_inner', id='field-mimetype-inner', label=_('MIME Type'), placeholder=_('eg. application/json'), value=data.mimetype_inner, error=errors.mimetype_inner, classes=[]) }}
                        {% endif %}
                        {% endblock %}

                    </div>
                </div>


            </div>
            <div class="paddingLeftHack paddingRightHack">
            <div class="form-actions">
                    {% block delete_button %}
                    {% if data.id %}
                    {% if h.check_access('resource_delete', {'id': data.id})  %}
                    {% set locale = h.dump_json({'content': _('Are you sure you want to delete this resource?')}) %}
                    <a class="btn btn-danger pull-left" href="{% url_for controller='package', action='resource_delete', resource_id=data.id, id=pkg_name %}" data-module="confirm-action" data-module-i18n="{{ locale }}">{% block delete_button_text %}{{ _('Delete') }}{% endblock %}</a>
                    {% endif %}
                    {% endif %}
                    {% endblock %}
                    {# if stage #}
                    {% block previous_button %}
                    {# <button class="btn" name="save" value="go-dataset" type="submit">{{ _('Previous') }}</button> #}
                    {% endblock %}
                    {% block again_button %}
                    <button class="btn" name="save" value="again" type="submit" id="mx-save-another">{{ _('Save & add another') }}</button>
                    {% endblock %}
                    {#}
                    <button class="btn btn-primary" name="save" value="go-metadata" type="submit" >{% block save_button_text %}{{ _('Next: Additional Info') }}{% endblock %}</button>
                    {% else #}
                    <button class="btn btn-primary" name="save" value="finish" type="submit" id="mx-save-dataset">{% block save_button_text2 %}{{ _('Add') }}{% endblock %}</button>
                    {# endif #}
            </div>
                </div>
        </div>
    </form>
